<style>
  body {
    margin: 100px auto;
    width: fit-content;
    height: fit-content;
  }
</style>
<pre>{}</pre>
<textarea oninput="rawws.push(Object.assign({}, rawws.storage, { first: event.target.value }))"></textarea>
<textarea oninput="rawws.push(Object.assign({}, rawws.storage, { second: event.target.value }))"></textarea>

<script src="https://unpkg.com/fast-json-patch@2.1.0/dist/fast-json-patch.js"></script>
<script type="module">
  import * as idb from 'https://unpkg.com/idb-keyval@3.1.0/dist/idb-keyval.mjs'
  window.ws = {}
  window.rawws = {
    async start() {
      if (!rawws.storage) rawws.storage = (await idb.get('rawws')) || {}
      if (!rawws.interval) rawws.interval = setInterval(() => ws.readyState === WebSocket.CLOSED && rawws.start(), 10000)
      ws = new WebSocket('ws://127.0.0.1:1111')
      ws.onopen = e => ws.send(localStorage.rawws || '0')
      ws.onmessage = e => rawws.pull(e.data)
    },
    pull(msg) {
      console.log('pull', msg)
      const patch = JSON.parse(msg)
      jsonpatch.applyPatch(rawws.storage, patch)
      localStorage.rawws = Date.now()
      rawws.push(true)
    },
    push(any) {
      console.log('push', any)
      if (typeof any === 'object') {
        const patch = jsonpatch.compare(rawws.storage, any)
        ws.send(JSON.stringify(patch))
        rawws.storage = any
      }
      idb.set('rawws', rawws.storage)
      document.querySelector('pre').innerText = JSON.stringify(rawws.storage, null, 2)
      document.querySelector('textarea:first-of-type').value = rawws.storage.first || ''
      document.querySelector('textarea:nth-of-type(2)').innerText = rawws.storage.second || ''
    },
  }
  rawws.start()
</script>
